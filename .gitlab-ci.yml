stages:
  - test

variables:
  NODE_VERSION: "18"

# Unit tests (no database required)
unit-tests:
  stage: test
  image: node:${NODE_VERSION}
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - backend/node_modules/
  before_script:
    - cd backend
    - npm install
  script:
    - npm test -- tasks.service.spec.ts
    - npm test -- app.controller.spec.ts
  only:
    - main
    - merge_requests

# E2E tests (with PostgreSQL service)
e2e-tests:
  stage: test
  image: node:${NODE_VERSION}
  services:
    - postgres:15
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
    DB_HOST: postgres
    DB_PORT: 5432
    DB_USERNAME: test_user
    DB_PASSWORD: test_password
    DB_NAME: test_db
    PORT: 4000
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - backend/node_modules/
  before_script:
    - cd backend
    - npm install
  script:
    - npm test -- test/tasks.e2e-spec.ts
    - npm test -- test/app.e2e-spec.ts
  only:
    - main
    - merge_requests
